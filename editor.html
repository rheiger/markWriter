<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>MarkWrite</title>

<!-- Toast UI Editor (WYSIWYG Markdown) - Local Assets -->
<link rel="stylesheet" href="assets/css/toastui-editor.min.css"/>
<script src="assets/js/toastui-editor-all.min.js"></script>

<!-- Mermaid.js for diagram rendering -->
<script src="assets/js/mermaid.min.js"></script>

<style>
  html, body { height: 100%; margin: 0; }
  #editor-root { height: 100vh; }
  .toastui-editor-defaultUI { width: 100%; margin: 0; }
  @media (prefers-color-scheme: dark) {
    body { background: #1e1e1e; color: #ddd; }
  }
  .mermaid {
    text-align: center;
    margin: 20px 0;
  }
  @media (prefers-color-scheme: dark) {
    .mermaid {
      filter: invert(1) hue-rotate(180deg);
    }
  }
  
  /* Button styling */
  #mermaid-btn, #render-mermaid-btn {
    transition: all 0.2s ease;
  }
  #mermaid-btn:hover, #render-mermaid-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  @media (prefers-color-scheme: dark) {
    #mermaid-btn, #render-mermaid-btn {
      background: #495057 !important;
      color: #fff !important;
    }
  }
</style>
</head>
<body>
<div style="padding: 10px; border-bottom: 1px solid #ddd; background: #f8f9fa;">
  <button id="mermaid-btn" style="padding: 8px 16px; margin-right: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
    ðŸ“Š Insert Mermaid Diagram
  </button>
  <button id="render-mermaid-btn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
    ðŸ”„ Render Diagrams
  </button>
</div>
<div id="editor-root"></div>
<script>
  function initializeEditor() {
    console.log('Initializing editor...');
    console.log('mermaid available:', typeof mermaid);
    console.log('toastui available:', typeof toastui);
    
    if (typeof mermaid === 'undefined') {
      console.error('Mermaid not loaded!');
      return;
    }
    
    if (typeof toastui === 'undefined') {
      console.error('Toast UI not loaded!');
      return;
    }
    
    mermaid.initialize({
      startOnLoad: true,
      theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default',
      securityLevel: 'loose',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true
      }
    });

    const { Editor } = toastui;
    const editor = new Editor({
      el: document.querySelector('#editor-root'),
      height: '100vh',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      usageStatistics: false,
      autofocus: true,
      toolbarItems: [
        ['heading', 'bold', 'italic', 'strike'],
        ['hr', 'quote'],
        ['ul', 'ol', 'task'],
        ['table'],
        ['link', 'image'],
        ['code', 'codeblock'],
        ['scrollSync']
      ]
    });

    // Add button event listeners
    document.getElementById('mermaid-btn').addEventListener('click', function() {
      const diagramCode = prompt('Enter Mermaid diagram code:');
      if (diagramCode) {
        const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
        const container = document.createElement('div');
        container.className = 'mermaid';
        container.id = id;
        container.style.margin = '20px 0';
        container.style.textAlign = 'center';
        container.textContent = diagramCode;
        
        // Insert at current cursor position
        const range = editor.getRange();
        editor.insertNode(range, container);
        
        // Render the diagram
        setTimeout(() => {
          mermaid.render(id, diagramCode).then(({ svg }) => {
            container.innerHTML = svg;
          }).catch(error => {
            console.error('Mermaid rendering error:', error);
            container.innerHTML = '<p style="color: red;">Error rendering diagram: ' + error.message + '</p>';
          });
        }, 100);
      }
    });
    
    document.getElementById('render-mermaid-btn').addEventListener('click', function() {
      renderExistingMermaidDiagrams();
    });
    
    // Function to find and render existing Mermaid diagrams
    function renderExistingMermaidDiagrams() {
      // Look for code blocks with mermaid language
      const codeBlocks = document.querySelectorAll('pre code');
      codeBlocks.forEach((codeBlock, index) => {
        const code = codeBlock.textContent;
        if (code.trim().startsWith('mermaid')) {
          const mermaidCode = code.replace(/^mermaid\s*\n/, '');
          const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
          
          // Create container for the diagram
          const container = document.createElement('div');
          container.className = 'mermaid';
          container.id = id;
          container.style.margin = '20px 0';
          container.style.textAlign = 'center';
          
          // Replace the code block with the diagram container
          const preElement = codeBlock.parentElement;
          preElement.parentElement.insertBefore(container, preElement.nextSibling);
          
          // Render the diagram
          setTimeout(() => {
            mermaid.render(id, mermaidCode).then(({ svg }) => {
              container.innerHTML = svg;
            }).catch(error => {
              console.error('Mermaid rendering error:', error);
              container.innerHTML = '<p style="color: red;">Error rendering diagram: ' + error.message + '</p>';
            });
          }, 100);
        }
      });
    }
    
    window._markwrite = {
      setMarkdown: function(md) {
        editor.setMarkdown(md || '');
        // Render Mermaid diagrams after content is set
        setTimeout(() => {
          renderExistingMermaidDiagrams();
        }, 500);
      },
      getMarkdown: function() { return editor.getMarkdown(); },
      getHTML: function() { return editor.getHTML(); },
      // New helper for rendering Mermaid diagrams
      renderMermaid: function() {
        renderExistingMermaidDiagrams();
      }
    };

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      const theme = e.matches ? 'dark' : 'default';
      mermaid.initialize({ theme: theme });
      mermaid.init(undefined, '.mermaid');
    });
  }
  
  initializeEditor();
</script>
</body>
</html>
