<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>MarkWrite</title>

<!-- Toast UI Editor (WYSIWYG Markdown) - Local Assets -->
<link rel="stylesheet" href="assets/css/toastui-editor.min.css"/>
<script src="assets/js/toastui-editor-all.min.js"></script>

<!-- Mermaid.js for diagram rendering -->
<script src="assets/js/mermaid.min.js"></script>

<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }

  #editor-root {
    height: 100vh;
    width: 100%;
    margin: 0;
    padding: 0;
  }

  .toastui-editor-defaultUI {
    width: 100%;
    height: 100vh !important;
    margin: 0;
  }

  .toastui-editor-main {
    height: calc(100vh - 60px) !important;
  }

  .toastui-editor-contents {
    height: 100% !important;
    overflow-y: auto !important;
  }

  /* Custom Mermaid button styling */
  .mermaid-button {
    width: 32px !important;
    height: 32px !important;
    border: none !important;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 16px !important;
    margin: 0 2px !important;
    border-radius: 4px !important;
    transition: background-color 0.2s !important;
  }

  .mermaid-button:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
  }

  /* Mermaid diagram containers */
  .mermaid-container {
    text-align: center;
    margin: 20px 0;
    border: 1px solid #ddd;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    min-height: 100px;
    position: relative;
  }

  /* Dark theme support */
  @media (prefers-color-scheme: dark) {
    body {
      background: #1e1e1e;
      color: #ddd;
    }

    .mermaid-container {
      background-color: #2d2d2d;
      border-color: #555;
    }
  }
</style>
</head>
<body>
<div id="editor-root"></div>

<script>
  // Debug logging function that routes to Python
  function debugLog(message, type = 'info') {
    // Send to Python via the bridge
    if (window._markwrite && window._markwrite.log) {
      window._markwrite.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Also log to console for backup
    console.log(`[${type.toUpperCase()}] ${message}`);
  }

  // Global variables
  let editor;
  let mermaidButton;

  // Initialize Mermaid
  mermaid.initialize({
    startOnLoad: true,
    theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default',
    securityLevel: 'loose',
    flowchart: {
      useMaxWidth: true,
      htmlLabels: true
    }
  });

  // Initialize the editor
  function initializeEditor() {
    debugLog('=== MARKWRITE INITIALIZATION START ===', 'info');
    debugLog('Initializing editor...', 'info');

    // Check if Mermaid and Toast UI are available
    if (typeof mermaid !== 'undefined') {
      debugLog('mermaid available: ' + typeof mermaid, 'info');
    } else {
      debugLog('‚ùå mermaid not available', 'error');
      return;
    }

    if (typeof toastui !== 'undefined') {
      debugLog('toastui available: ' + typeof toastui, 'info');
      debugLog('toastui version: ' + (toastui.version || 'unknown'), 'info');
    } else {
      debugLog('‚ùå toastui not available', 'error');
      return;
    }

    try {
      // Create the editor with minimal configuration to avoid errors
      editor = new toastui.Editor({
        el: document.querySelector('#editor-root'),
        height: '100%',
        initialEditType: 'wysiwyg',
        previewStyle: 'vertical'
      });

      debugLog('Editor created successfully', 'success');
      debugLog('Editor object: ' + typeof editor, 'info');

      // Wait for editor to be fully initialized
      setTimeout(() => {
        debugLog('=== EDITOR IS READY ===', 'success');
        debugLog('Toolbar element: ' + (document.querySelector('.toastui-editor-toolbar') ? 'found' : 'not found'), 'success');
        debugLog('Editor content element: ' + (document.querySelector('.toastui-editor-contents') ? 'found' : 'not found'), 'success');

        // Add Mermaid button to toolbar
        addMermaidButton();
        addStandardToolbarButtons(); // Add standard toolbar buttons

        // Force scroll to top
        forceScrollToTop();

        // Look for existing Mermaid diagrams
        renderExistingMermaidDiagrams();

        // Force scroll to top again after a delay to ensure it sticks
        setTimeout(() => {
          forceScrollToTop();
        }, 2000);
      }, 1000);

    } catch (error) {
      debugLog('‚ùå Error creating editor: ' + error.message, 'error');
      debugLog('Error stack: ' + error.stack, 'error');

      // Fallback: try to create a basic textarea
      const fallbackEditor = document.createElement('textarea');
      fallbackEditor.style.cssText = 'width: 100%; height: 100%; border: none; padding: 20px; font-family: monospace; font-size: 14px;';
      fallbackEditor.placeholder = 'Editor failed to load. This is a fallback textarea.';
      document.getElementById('editor-root').appendChild(fallbackEditor);
    }
  }

  // Add Mermaid button to toolbar
  function addMermaidButton() {
    debugLog('=== ADDING MERMAID BUTTON ===', 'info');

    // Create Mermaid button
    const mermaidButton = document.createElement('button');
    mermaidButton.className = 'mermaid-button';
    mermaidButton.title = 'Insert Mermaid Diagram';
    mermaidButton.innerHTML = 'üìä';
    mermaidButton.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 14px; margin: 0 2px;';

    // Add click handler
    mermaidButton.addEventListener('click', function() {
      insertMermaidDiagram();
    });

    // Find the toolbar and add the button
    const toolbar = document.querySelector('.toastui-editor-toolbar');
    if (toolbar) {
      // Look for the last toolbar group
      const toolbarGroups = toolbar.querySelectorAll('.toastui-editor-toolbar-group');
      if (toolbarGroups.length > 0) {
        const lastGroup = toolbarGroups[toolbarGroups.length - 1];
        lastGroup.appendChild(mermaidButton);
        debugLog('‚úÖ Mermaid button added to last toolbar group', 'success');
      } else {
        // Fallback: add directly to toolbar
        toolbar.appendChild(mermaidButton);
        debugLog('‚úÖ Mermaid button added directly to toolbar', 'success');
      }
    } else {
      debugLog('‚ùå Toolbar not found for Mermaid button', 'error');
    }
  }

  // Add standard toolbar buttons manually
  function addStandardToolbarButtons() {
    debugLog('=== ADDING STANDARD TOOLBAR BUTTONS ===', 'info');

    const toolbar = document.querySelector('.toastui-editor-toolbar');
    if (!toolbar) {
      debugLog('‚ùå Toolbar not found for standard buttons', 'error');
      return;
    }

    // Create a new toolbar group for our custom buttons
    const customGroup = document.createElement('div');
    customGroup.className = 'toastui-editor-toolbar-group';
    customGroup.style.cssText = 'display: flex; align-items: center; margin: 0 8px;';

    // Add file operation buttons
    const buttons = [
      { text: 'üìÅ', title: 'Open File', action: 'open' },
      { text: 'üíæ', title: 'Save', action: 'save' },
      { text: 'üíæ+', title: 'Save As', action: 'saveAs' },
      { text: 'üîç+', title: 'Zoom In', action: 'zoomIn' },
      { text: 'üîç-', title: 'Zoom Out', action: 'zoomOut' }
    ];

    buttons.forEach(btn => {
      const button = document.createElement('button');
      button.innerHTML = btn.text;
      button.title = btn.title;
      button.style.cssText = 'width: 32px; height: 32px; border: 1px solid #ddd; background: white; cursor: pointer; margin: 0 2px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px;';

      button.addEventListener('click', function() {
        debugLog(`Button clicked: ${btn.action}`, 'info');
        // These will be handled by the Python bridge
        if (window._markwrite && window._markwrite[btn.action]) {
          window._markwrite[btn.action]();
        }
      });

      customGroup.appendChild(button);
    });

    // Add the custom group to the toolbar
    toolbar.appendChild(customGroup);
    debugLog('‚úÖ Standard toolbar buttons added', 'success');
  }

  // Force scroll to top
  function forceScrollToTop() {
    debugLog('=== FORCING SCROLL TO TOP ===', 'info');
    try {
      // Multiple scroll targets to ensure we catch all
      window.scrollTo(0, 0);
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;

      // Also try to scroll the editor content
      const editorContent = document.querySelector('.toastui-editor-contents');
      if (editorContent) {
        editorContent.scrollTop = 0;
      }

      // Try scrolling the main editor area
      const editorMain = document.querySelector('.toastui-editor-main');
      if (editorMain) {
        editorMain.scrollTop = 0;
      }

      // Try scrolling the default UI container
      const defaultUI = document.querySelector('.toastui-editor-defaultUI');
      if (defaultUI) {
        defaultUI.scrollTop = 0;
      }

      // Force scroll after a short delay to ensure DOM is ready
      setTimeout(() => {
        window.scrollTo(0, 0);
        if (editorContent) editorContent.scrollTop = 0;
        if (editorMain) editorMain.scrollTop = 0;
        if (defaultUI) defaultUI.scrollTop = 0;
      }, 100);

      debugLog('Scroll position set to top SUCCESS', 'success');
    } catch (e) {
      debugLog('Scroll to top failed: ' + e.message, 'error');
    }
  }

  // Insert a new Mermaid diagram
  function insertMermaidDiagram() {
    debugLog('=== INSERTING NEW MERMAID DIAGRAM ===', 'info');

    const defaultDiagram = `flowchart TD
    A[Start] --> B{Decision?}
    B -->|Yes| C[Process]
    B -->|No| D[End]
    C --> D`;

    const diagramCode = prompt('Enter Mermaid diagram code:', defaultDiagram);
    if (diagramCode) {
      // Insert as a code block
      editor.insertText('```mermaid\n' + diagramCode + '\n```');

      // Render the diagram
      setTimeout(() => {
        findAndRenderMermaidDiagrams();
      }, 500);
    }
  }

  // Render existing Mermaid diagrams
  function renderExistingMermaidDiagrams() {
    debugLog('=== LOOKING FOR EXISTING MERMAID DIAGRAMS ===', 'info');

    // Wait for content to be fully loaded
    setTimeout(() => {
      findAndRenderMermaidDiagrams();
    }, 1000);
  }

  // Find and render Mermaid diagrams
  function findAndRenderMermaidDiagrams() {
    debugLog('=== FINDING AND RENDERING MERMAID DIAGRAMS ===', 'info');

    // Try multiple approaches to find the editor content
    let editorContent = document.querySelector('.toastui-editor-contents');
    if (!editorContent) {
      editorContent = document.querySelector('.toastui-editor-main');
    }
    if (!editorContent) {
      editorContent = document.querySelector('[data-testid="editor"]');
    }
    if (!editorContent) {
      editorContent = document.querySelector('#editor-root');
    }

    if (!editorContent) {
      debugLog('‚ùå Editor content not found', 'error');
      return;
    }

    debugLog(`‚úÖ Found editor content: ${editorContent.className}`, 'success');

    // Find all code blocks - try multiple selectors
    let codeBlocks = editorContent.querySelectorAll('pre code');
    if (codeBlocks.length === 0) {
      codeBlocks = editorContent.querySelectorAll('code');
    }
    if (codeBlocks.length === 0) {
      codeBlocks = editorContent.querySelectorAll('pre');
    }

    debugLog(`Found ${codeBlocks.length} code blocks in editor`, 'info');

    let processingCount = 0;
    let renderedCount = 0;

    codeBlocks.forEach((codeBlock, index) => {
      const code = codeBlock.textContent || codeBlock.innerText;
      debugLog(`Processing code block ${index}: ${code.substring(0, 100)}`, 'info');

      // Check if this is a Mermaid diagram by looking for Mermaid syntax patterns
      const isMermaidDiagram = code && (
        code.trim().startsWith('mermaid') ||
        code.trim().startsWith('flowchart') ||
        code.trim().startsWith('graph') ||
        code.trim().startsWith('sequenceDiagram') ||
        code.trim().startsWith('classDiagram') ||
        code.trim().startsWith('stateDiagram') ||
        code.trim().startsWith('erDiagram') ||
        code.trim().startsWith('journey') ||
        code.trim().startsWith('gantt') ||
        code.trim().startsWith('pie') ||
        code.trim().startsWith('quadrantChart') ||
        code.trim().startsWith('requirement') ||
        code.trim().startsWith('gitgraph') ||
        code.trim().startsWith('C4Context') ||
        code.trim().startsWith('mindmap')
      );

      if (isMermaidDiagram) {
        processingCount++;
        // Extract the diagram code (remove 'mermaid' prefix if present)
        const mermaidCode = code.replace(/^mermaid\s*\n?/, '');
        const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);

        debugLog(`üé® Rendering Mermaid diagram: ${id}`, 'info');
        debugLog(`Diagram type detected: ${code.trim().split(/\s/)[0]}`, 'info');

        // Create container for the diagram with toggle functionality
        const container = document.createElement('div');
        container.className = 'mermaid-container';
        container.id = id;
        container.style.margin = '20px 0';
        container.style.textAlign = 'center';
        container.style.border = '1px solid #ddd';
        container.style.padding = '20px';
        container.style.backgroundColor = '#f8f9fa';
        container.style.borderRadius = '8px';
        container.style.minHeight = '100px';
        container.style.position = 'relative';

        // Add toggle button
        const toggleButton = document.createElement('button');
        toggleButton.textContent = 'üìù Edit';
        toggleButton.style.position = 'absolute';
        toggleButton.style.top = '5px';
        toggleButton.style.right = '5px';
        toggleButton.style.padding = '4px 8px';
        toggleButton.style.fontSize = '12px';
        toggleButton.style.backgroundColor = '#007bff';
        toggleButton.style.color = 'white';
        toggleButton.style.border = 'none';
        toggleButton.style.borderRadius = '4px';
        toggleButton.style.cursor = 'pointer';
        toggleButton.style.zIndex = '1000';

        // Store references to elements for toggle functionality
        container.dataset.preElementId = 'pre-' + id;
        container.dataset.mermaidCode = mermaidCode;

        // Add toggle functionality
        toggleButton.addEventListener('click', function() {
          toggleMermaidEdit(container, preElement);
        });

        container.appendChild(toggleButton);

        // Insert the container after the code block's parent (the pre element)
        const preElement = codeBlock.parentElement;
        if (preElement && preElement.parentElement) {
          // Give the pre element a unique ID for toggle functionality
          preElement.id = 'pre-' + id;
          preElement.style.display = 'none';

          preElement.parentElement.insertBefore(container, preElement.nextSibling);

          // Render the diagram
          setTimeout(() => {
            mermaid.render(id, mermaidCode).then(({ svg }) => {
              // Ensure the container still exists and SVG is valid
              if (container && container.parentNode && svg) {
                container.appendChild(svg);
                debugLog(`‚úÖ Mermaid diagram rendered successfully: ${id}`, 'success');
                renderedCount++;

                // Check if all diagrams are done
                if (renderedCount === processingCount) {
                  debugLog(`üéØ All ${renderedCount} Mermaid diagrams rendered successfully`, 'success');
                }
              } else {
                debugLog(`‚ùå Container or SVG invalid for diagram: ${id}`, 'error');
                renderedCount++;
              }
            }).catch(error => {
              debugLog(`‚ùå Mermaid rendering error: ${error.message}`, 'error');
              if (container && container.parentNode) {
                container.innerHTML = '<p style="color: red;">Error rendering diagram: ' + error.message + '</p>';
              }
              renderedCount++;
            });
          }, 100);
        }
      }
    });

    // If no diagrams were found, don't retry indefinitely
    if (processingCount === 0) {
      debugLog('No Mermaid diagrams found in this content', 'info');
    } else {
      debugLog(`Processing ${processingCount} Mermaid diagrams...`, 'info');

      // Force scroll to top after diagrams are processed
      setTimeout(() => {
        forceScrollToTop();
      }, 500);
    }
  }

  // Toggle Mermaid diagram edit mode
  function toggleMermaidEdit(container, preElement) {
    debugLog('=== TOGGLE MERMAID EDIT MODE ===', 'info');
    const mermaidCode = container.dataset.mermaidCode;
    const newMermaidCode = prompt('Edit Mermaid Diagram Code:', mermaidCode);

    if (newMermaidCode !== null) {
      // Update the Mermaid code in the container
      container.dataset.mermaidCode = newMermaidCode;
      // Re-render the diagram with the new code
      mermaid.render(container.id, newMermaidCode).then(({ svg }) => {
        // Clear existing SVG and append new one
        container.innerHTML = '';
        container.appendChild(svg);
        debugLog(`‚úÖ Mermaid diagram updated successfully: ${container.id}`, 'success');
      }).catch(error => {
        debugLog(`‚ùå Mermaid rendering error during update: ${error.message}`, 'error');
        container.innerHTML = '<p style="color: red;">Error updating diagram: ' + error.message + '</p>';
      });
    }
  }

  window._markwrite = {
    setMarkdown: function(md) {
      if (editor) {
        editor.setMarkdown(md || '');
        // Render Mermaid diagrams after content is set
        setTimeout(() => {
          findAndRenderMermaidDiagrams();
          // Force scroll to top after content is loaded
          forceScrollToTop();
        }, 1500);
      }
    },
    getMarkdown: function() {
      return editor ? editor.getMarkdown() : '';
    },
    getHTML: function() {
      return editor ? editor.getHTML() : '';
    },
    // New helper for rendering Mermaid diagrams
    renderMermaid: function() {
      findAndRenderMermaidDiagrams();
    },
    // New logging function to route JS logs to Python
    log: function(message) {
      // This will be handled by Python
      console.log(`[PYTHON] ${message}`);
    }
  };

  // Initialize the editor
  initializeEditor();

  // Handle theme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    const theme = e.matches ? 'dark' : 'default';
    mermaid.initialize({ theme: theme });
    mermaid.init(undefined, '.mermaid');
  });
</script>
</body>
</html>
